<!DOCTYPE html>
<html>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Search Results</title>
  <link rel="stylesheet" type="text/css" href="m.css">
  <script type="text/javascript">

    var classPrefix = '';
    ///////////////////////////////////////////////////////////////////////////
    // copied functions from m.js
    function preventDefault(e) {
        e = e || window.event;
        e.returnValue = false; if (e.preventDefault) e.preventDefault();
    }
    function stopPropagation(e) {
        e = e || window.event;
        e.cancelBubble = true; if (e.stopPropagation) e.stopPropagation();
    }
    function createElement(parent, name, clazz, text) {
        var element = document.createElement(name);
        if (parent) {
            parent.appendChild(element);
        }
        if (clazz) {
            element.setAttribute('class', classPrefix + clazz);
        }
        if (text) {
            element.appendChild(document.createTextNode(text));
        }
        return element;
    }
    var openRequest;
    function remoteRequest(url, callbackFn, uncancelable) {
        var request = new XMLHttpRequest();
        request.onreadystatechange = function() {
            if (request.readyState == 4 && request.status == 200)
                callbackFn(request.responseText);
        }
        request.open('GET', url);
        request.send();
        if (openRequest && openRequest.abort) openRequest.abort();
        if (!uncancelable) openRequest = request;
    }
    function addHighlightedText(element, text, searchWord) {
        var searchWordLowerCase = searchWord.toLowerCase();
        var textLowerCase = text.toLowerCase();
        var hIndex = textLowerCase.indexOf(searchWordLowerCase);
        if (hIndex < 0) {
            element.appendChild(document.createTextNode(text));
            return;
        }

        var lastEnd = 0;
        while (hIndex >=0) {
            element.appendChild(document.createTextNode(text.substring(lastEnd, hIndex)));
            lastEnd = hIndex + searchWord.length;
            if (   hIndex == 0
                || text.substring(hIndex - 1, hIndex).replace(/\w/, "").length != 0) {
                createElement(element, 'strong', false, text.substring(hIndex, lastEnd));
            } else {
                element.appendChild(document.createTextNode(text.substring(hIndex, lastEnd)));
            }
            hIndex = textLowerCase.indexOf(searchWordLowerCase, lastEnd);
        }
        element.appendChild(document.createTextNode(text.substring(lastEnd)));
    }
    ///////////////////////////////////////////////////////////////////////////

    var topCount = 10;
    var maxPerGroup = 3;
    function asTree(results, path, depth) {
        if (depth < 1) return results;
        var tree = [];
        var grouped = {};
        for (var i = 0; i < results.length; i++) {
            var r = results[i];
            if (!r.path || r.path.length < path.length + 2) {
                tree.push(r);
            } else {
                var key = r.path[path.length] + '\n' + r.path[path.length+1];
                if (!grouped[key]) {
                    var node = { isNode: true, top: r.top, name: [r.path[path.length], r.path[path.length+1]], children: [r] };
                    grouped[key] = node;
                    tree.push(node);
                } else {
                    grouped[key].children.push(r);
                }
            }
        }
        for (var i = 0; i < tree.length; i++) {
            if (!tree[i].isNode) continue;
            tree[i].count = tree[i].children.length;
            tree[i].children = asTree(tree[i].children, tree[i].children[0].path.slice(0, path.length+2), depth - 1);
        }
        return tree;
    }
    var results = [];
    var searchWord = '';
    var scopeName = false;
    function init() {
        var href = window.location.href;
        if (!href || href.indexOf('/m_search.html?') < 0) return;
        function callback(data) {
            var match = new RegExp('window.location.replace[^\\?]*\\?([^"]*)').exec(data);
            if (match == null) return;

            // search word
            var element = createElement(null, 'div');
            element.innerHTML = match[1].replace(/\\u([0-9A-F]{4})/g,'&#x$1;');
            searchWord = (element.textContent ? element.textContent : element.innerText).replace(/\*(?=\&)|(^searchWord=)|(\&maxHits=.+$)/g,'');
            searchWord = searchWord.indexOf('&') < 0 ? searchWord : searchWord.substr(0, searchWord.indexOf('&'));
            searchWord = decodeURIComponent(searchWord.replace(/\+/g, '%20'));
            var isSkoped = window.location.href.indexOf('&toc=') > 0;
            scopeName = false;

            // parse HTML for results
            var withBreadcrumbs = false;
            var pattern = new RegExp('<tr[^<]*<td[^<]*<img[^<]*</td[^<]*<td[^<]*<a\\s+(?:(?:class|id|title|onmouseover|onmouseout)\\s*=\\s*(?:(?:\'[^\']*\')|(?:"[^"]*"))\\s+)*href="([^"]*)"(?:\\s+o\\w+="[^"]*")*\\s+title="([^"]*)"[^>]*>([^<]*)</a>(?:(?:(?!<[/]?tr)[\\s\\S])*</tr\\s*>\\s*<tr(?:(?!</tr)(?!class="location">)[\\s\\S])*class="location">((?:(?!</div)[\\s\\S])*))?(?:(?:(?!</tr)(?!\\sclass=["\']description["\'])[\\s\\S])*</tr){1,2}(?:(?!</tr)(?!\\sclass=["\']description["\'])[\\s\\S])*\\sclass=["\']description["\'][^>]*>([^<]*)', 'g');
            for (; (match = pattern.exec(data)) != null;) {
                var items = [];
                for (var i = 1; i < 6; i++) {
                    element.innerHTML = match[i];
                    items.push((element.textContent ? element.textContent : element.innerText).replace(/^\s+|\s+$/g,'').replace(/\s+/g,' '));
                }
                var breadcrumb = [];
                if (match[4]) {
                    var breadcrumbPattern = new RegExp('<a\\s+href="([^"]+)">([^<]+)</a>', 'g');
                    for (; (breadcrumbMatch = breadcrumbPattern.exec(match[4])) != null;) {
                        for (var i = 1; i < 3; i++) {
                            element.innerHTML = breadcrumbMatch[i];
                            breadcrumb.push((element.textContent ? element.textContent : element.innerText).replace(/^\s+|\s+$/g,'').replace(/\s+/g,' '));
                        }
                    }
                    if (isSkoped && !scopeName && breadcrumb.length > 1) scopeName = breadcrumb[1];
                    withBreadcrumbs = true;
                }
                results.push({
                    title: items[2],
                    desc: (items[4] ? items[4] : items[3]),
                    href: items[0].substring(8),
                    path: breadcrumb,
                    top: (results.length < topCount)
, pos: (results.length+1)
                });
            }

            // remove "Searching..."
            var out = document.getElementById("results");
            while (out.firstChild) {
                out.removeChild(out.firstChild);
            }

            // show results
            if (results.length > 0) {
                var s = createElement(out, 'div', 'stats', results.length + ' results');
                if (scopeName) {
                    s.appendChild(document.createTextNode(' in '));
                    createElement(s, 'span', 'scope', scopeName);
                }
                s.appendChild(document.createTextNode(':'));
            } else {
                var noResults = createElement(out, 'div', 'no-results', 'No topics found containing ');
                createElement(noResults, 'strong', false, searchWord);
            }
            showResults(results, withBreadcrumbs, createElement(out, 'ul'), scopeName ? 1 : 0);
        }
        var url = href.replace('/m_search.html?', '/../../advanced/searchView.jsp?');
        remoteRequest(url, callback);

        // for local help viewer show history buttons
        if (parent && parent.showHistoryButtons) parent.showHistoryButtons();
    }

    function showResults(resultList, showAsTree, ul, depth) {

        var results = !showAsTree || resultList.length <= topCount
                      ? resultList
                      : asTree(resultList, resultList[0].path.slice(0, depth * 2), 1);

        var previousTop = false;
        var more;
        var hidden = [];
        for (var i = 0; i < results.length; i++) {
            var n = results[i];
            var r = createElement(ul, 'li');

            // subtree
            if (showAsTree && n.isNode && n.children.length > 1) {
                var name = '';
                for (var j = 0; j < n.name.length; j+=2) {
                    name += (j == 0 ? '' : ' > ') + n.name[j+1];
                }
                var sub = createElement(r, 'div', 'scope');
                addHighlightedText(sub, name, searchWord);
                createElement(sub, 'span', 'count', ' (' + n.count + ')');
                var subUl = createElement(r, 'ul');
                var shown = 0;
                for (var j = 0; j < n.children.length; j++) {
                    if (shown == maxPerGroup || !n.children[j].top) {
                        var more = createElement(subUl, 'li', 'more', 'More...');
                        more.onclick = function(out, results, depth) {
                            return function(e) {
                                while (out.firstChild) {
                                    out.removeChild(out.firstChild);
                                }
                                showResults(results, true, out, depth);
                            };
                        }(subUl, n.children, depth + 1);
                        break;
                    }
                    shown++;
                    showItem(n.children[j], createElement(subUl, 'li'), showAsTree, depth + 1);
                }

            } else {
                showItem(n, r, showAsTree, depth);
            }
        }
        if (parent && parent.updateContentFrameSize) parent.updateContentFrameSize();
    }

    function showItem(node, r, showAsTree, breadcrumbFrom) {
        r.setAttribute('class', 'r');

        // title (linked)
        var rt = createElement(r, 'h4');
        var ra = createElement(rt, 'a', false);
        ra.setAttribute('href', '../../topic' + node.href);
        addHighlightedText(ra, node.title
+ (showAsTree ? ' [' + node.pos + ']' : '')
             , searchWord);

        // breadcrumb (if available)
        if (node.path.length > 0) {
            rb = createElement(r, 'div');
            var crumb = node.path.slice(breadcrumbFrom * 2);
            for (var j = 0; j < crumb.length; j+=2) {
                rbi = createElement(rb, 'span');
                addHighlightedText(rbi, crumb[j+1], searchWord);
                if (j < crumb.length-2) createElement(rbi, 'span', false, ' > ');
            }
        }

        // description
        addHighlightedText(createElement(r, 'p'), node.desc, searchWord);

    }

  </script>
</head>
<body onLoad="init()">
<div id="results"><p>Searching...</p></div>
</body>
</html>