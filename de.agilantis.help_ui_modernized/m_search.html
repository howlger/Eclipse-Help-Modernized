<!DOCTYPE html>
<html>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Search Results</title>
  <link rel="stylesheet" type="text/css" href="m.css">
  <script type="text/javascript">

    var classPrefix = '';
    ///////////////////////////////////////////////////////////////////////////
    // copied functions from m.js
    function preventDefault(e) {
        e = e || window.event;
        e.returnValue = false; if (e.preventDefault) e.preventDefault();
    }
    function stopPropagation(e) {
        e = e || window.event;
        e.cancelBubble = true; if (e.stopPropagation) e.stopPropagation();
    }
    function createElement(parent, name, clazz, text) {
        var element = document.createElement(name);
        if (parent) {
            parent.appendChild(element);
        }
        if (clazz) {
            element.setAttribute('class', classPrefix + clazz);
        }
        if (text) {
            element.appendChild(document.createTextNode(text));
        }
        return element;
    }
    var openRequest;
    function remoteRequest(url, callbackFn, uncancelable) {
        var request = new XMLHttpRequest();
        request.onreadystatechange = function() {
            if (request.readyState == 4 && request.status == 200)
                callbackFn(request.responseText);
        }
        request.open('GET', url);
        request.send();
        if (openRequest && openRequest.abort) openRequest.abort();
        if (!uncancelable) openRequest = request;
    }
    function addHighlightedText(element, text, searchWord) {
        var searchWordLowerCase = searchWord.toLowerCase();
        var textLowerCase = text.toLowerCase();
        var hIndex = textLowerCase.indexOf(searchWordLowerCase);
        if (hIndex < 0) {
            element.appendChild(document.createTextNode(text));
            return;
        }

        var lastEnd = 0;
        while (hIndex >=0) {
            element.appendChild(document.createTextNode(text.substring(lastEnd, hIndex)));
            lastEnd = hIndex + searchWord.length;
            if (   hIndex == 0
                || text.substring(hIndex - 1, hIndex).replace(/\w/, "").length != 0) {
                createElement(element, 'strong', false, text.substring(hIndex, lastEnd));
            } else {
                element.appendChild(document.createTextNode(text.substring(hIndex, lastEnd)));
            }
            hIndex = textLowerCase.indexOf(searchWordLowerCase, lastEnd);
        }
        element.appendChild(document.createTextNode(text.substring(lastEnd)));
    }
    ///////////////////////////////////////////////////////////////////////////

    var topCount = 10;
    function asTree(results, path) {
        var tree = [];
        var grouped = {};
        for (var i = 0; i < results.length; i++) {
            var r = results[i];
            if (!r.path || r.path.length < path.length + 2) {
                tree.push(r);
            } else {
                var key = r.path[path.length] + '\n' + r.path[path.length+1];
                if (!grouped[key]) {
                    var node = { isNode: true, top: r.top, name: [r.path[path.length], r.path[path.length+1]], children: [r] };
                    grouped[key] = node;
                    tree.push(node);
                } else {
                    grouped[key].children.push(r);
                }
            }
        }
        for (var i = 0; i < tree.length; i++) {
            if (!tree[i].isNode) continue;
            tree[i].count = tree[i].children.length;
            tree[i].children = asTree(tree[i].children, tree[i].children[0].path.slice(0, path.length+2));
        }
        return tree;
    }
    function compactTree(tree) {
        for (var i = 0; i < tree.length; i++) {
            var node = tree[i];
            if (!node.isNode) continue;
            while(node.children.length == 1 && node.children[0].isNode) {
                var subnode = node.children[0];
                for (var j = 0; j < subnode.name.length; j++) node.name.push(subnode.name[j]);
                node.children = subnode.children;
            }
            compactTree(node.children);
        }
    }
    var results = [];
    var tree = undefined;
    var searchWord = '';
    var scopeName = false;
    function init() {
        var href = window.location.href;
        if (!href || href.indexOf('/m_search.html?') < 0) return;
        function callback(data) {
            var match = new RegExp('window.location.replace[^\\?]*\\?([^"]*)').exec(data);
            if (match == null) return;

            // search word
            var element = createElement(null, 'div');
            element.innerHTML = match[1].replace(/\\u([0-9A-F]{4})/g,'&#x$1;');
            searchWord = (element.textContent ? element.textContent : element.innerText).replace(/\*(?=\&)|(^searchWord=)|(\&maxHits=.+$)/g,'');
            searchWord = searchWord.indexOf('&') < 0 ? searchWord : searchWord.substr(0, searchWord.indexOf('&'));
            searchWord = decodeURIComponent(searchWord.replace(/\+/g, '%20'));
            var isSkoped = window.location.href.indexOf('&toc=') > 0;
            scopeName = false;

            // parse HTML for results
            var withBreadcrumbs = false;
            var pattern = new RegExp('<tr[^<]*<td[^<]*<img[^<]*</td[^<]*<td[^<]*<a\\s+(?:(?:class|id|title|onmouseover|onmouseout)\\s*=\\s*(?:(?:\'[^\']*\')|(?:"[^"]*"))\\s+)*href="([^"]*)"(?:\\s+o\\w+="[^"]*")*\\s+title="([^"]*)"[^>]*>([^<]*)</a>(?:(?:(?!<[/]?tr)[\\s\\S])*</tr\\s*>\\s*<tr(?:(?!</tr)(?!class="location">)[\\s\\S])*class="location">((?:(?!</div)[\\s\\S])*))?(?:(?:(?!</tr)(?!\\sclass=["\']description["\'])[\\s\\S])*</tr){1,2}(?:(?!</tr)(?!\\sclass=["\']description["\'])[\\s\\S])*\\sclass=["\']description["\'][^>]*>([^<]*)', 'g');
            for (; (match = pattern.exec(data)) != null;) {
                var items = [];
                for (var i = 1; i < 6; i++) {
                    element.innerHTML = match[i];
                    items.push((element.textContent ? element.textContent : element.innerText).replace(/^\s+|\s+$/g,'').replace(/\s+/g,' '));
                }
                var breadcrumb = [];
                if (match[4]) {
                    var breadcrumbPattern = new RegExp('<a\\s+href="([^"]+)">([^<]+)</a>', 'g');
                    for (; (breadcrumbMatch = breadcrumbPattern.exec(match[4])) != null;) {
                        for (var i = 1; i < 3; i++) {
                            element.innerHTML = breadcrumbMatch[i];
                            breadcrumb.push((element.textContent ? element.textContent : element.innerText).replace(/^\s+|\s+$/g,'').replace(/\s+/g,' '));
                        }
                        tree = [];
                    }
                    if (isSkoped && !scopeName && breadcrumb.length > 1) scopeName = breadcrumb[1];
                    withBreadcrumbs = true;
                }
                results.push({
                    title: items[2],
                    desc: (items[4] ? items[4] : items[3]),
                    href: items[0].substring(8),
                    path: breadcrumb,
                    top: (results.length < topCount)
, pos: (results.length+1)
                });
            }
            if (tree) {
                tree = asTree(results, isSkoped ? results[0].path.slice(0, 2) : []);
                compactTree(tree);
            }

            // remove "Searching..."
            var out = document.getElementById("results");
            while (out.firstChild) {
                out.removeChild(out.firstChild);
            }

            // show results
            if (results.length > 0) {
                var s = createElement(out, 'div', 'stats', results.length + ' results');
                if (scopeName) {
                    s.appendChild(document.createTextNode(' in '));
                    createElement(s, 'span', 'scope', scopeName);
                }
                s.appendChild(document.createTextNode(':'));
            } else {
                var noResults = createElement(out, 'div', 'no-results', 'No topics found containing ');
                createElement(noResults, 'strong', false, searchWord);
            }
            showResults(withBreadcrumbs ? tree : results, withBreadcrumbs, out, 0);
        }
        var url = href.replace('/m_search.html?', '/../../advanced/searchView.jsp?');
        remoteRequest(url, callback);

        // for local help viewer show history buttons
        if (parent && parent.showHistoryButtons) parent.showHistoryButtons();
    }

    function showResults(results, showAsTree, out, depth) {
         var rl = createElement(out, 'ul');
         var previousTop = false;
         var more;
         var hidden = [];
         for (var i = 0; i < results.length; i++) {
             var n = results[i];

             // top end?
             if (depth > 0 && previousTop && !n.top) {
                 more = createElement(rl, 'li', 'more', 'More...');
             }
             previousTop = n.top;

             // list element
             var r = createElement(rl, 'li');
             if (more) {
                 hidden.push(r);
                 r.style.display = 'none';
             }

             // subtree
             if (showAsTree && n.isNode && !(n.children.length == 1 && !n.children[0].isNode)) {
                 var name = '';
                 for (var j = 0; j < n.name.length; j+=2) {
                     name += (j == 0 ? '' : ' > ') + n.name[j+1];
                 }
                 var sub = createElement(r, 'div', 'scope');
                 addHighlightedText(sub, name, searchWord);
                 createElement(sub, 'span', 'count', ' (' + n.count + ')');
                 showResults(n.children, showAsTree, r, depth+1);
                 continue;
             }

             var node = n.isNode ? n.children[0] : n;
             r.setAttribute('class', 'r');

             // open result on click/touch
             r.onclick = function(a, b) {return function(e) {preventDefault(e); if (!a.canceled && (e.button == undefined || e.button == 0)) {location = b}}}(r, '../../topic' + node.href);

             // title (linked)
             var rt = createElement(r, 'h4');
             var ra = createElement(rt, 'a', false);
             ra.setAttribute('href', '../../topic' + node.href);
             addHighlightedText(ra, node.title
+ (showAsTree ? ' [' + node.pos + ']' : '')
                     , searchWord);

             // breadcrumb (if available)
             if (node.path.length > 0) {
                 rb = createElement(r, 'div');
                 var crumb = showAsTree
                             ? (n.isNode ? n.name : [])
                             : (scopeName ? node.path.slice(2) : node.path);
                 for (var j = 0; j < crumb.length; j+=2) {
                     rbi = createElement(rb, 'span');
                     addHighlightedText(rbi, crumb[j+1], searchWord);
                     if (j < crumb.length-2) createElement(rbi, 'span', false, ' > ');
                 }
             }

             // description
             addHighlightedText(createElement(r, 'p'), node.desc, searchWord);
         }
         if (more) more.onclick = function(more, rest) {
             return function(e) {
                 var state = more.innerHTML.indexOf('More') < 0;
                 more.innerHTML = (state ? 'More...' : 'Less...');
                 for (var i = 0; i < rest.length; i++) rest[i].style.display = state ? 'none' : 'block';
             };
         }(more, hidden);
         if (parent && parent.updateContentFrameSize) parent.updateContentFrameSize();

    }

  </script>
</head>
<body onLoad="init()">
<div id="results"><p>Searching...</p></div>
</body>
</html>